ML RETRIES INFRASTRUCTURE - Project Structure
==============================================

dpa-tesis-2025-2/
â”‚
â”œâ”€â”€ ğŸ“„ Package & Config Files
â”‚   â”œâ”€â”€ package.json                    [Dependencias Node.js]
â”‚   â”œâ”€â”€ tsconfig.json                   [Config TypeScript]
â”‚   â”œâ”€â”€ cdk.json                        [Config CDK]
â”‚   â”œâ”€â”€ .gitignore                      [Archivos ignorados por Git]
â”‚   â””â”€â”€ .env.example                    [Template de variables de entorno]
â”‚
â”œâ”€â”€ ğŸ“š DocumentaciÃ³n
â”‚   â”œâ”€â”€ README.md                       [DocumentaciÃ³n tÃ©cnica completa â­]
â”‚   â”œâ”€â”€ QUICKSTART.md                   [GuÃ­a rÃ¡pida de inicio â­]
â”‚   â”œâ”€â”€ MANIFEST.md                     [Inventario de archivos]
â”‚   â””â”€â”€ PROJECT_STRUCTURE.txt           [Este archivo]
â”‚
â”œâ”€â”€ ğŸ—ï¸ AWS CDK - Infraestructura (TypeScript)
â”‚   â”œâ”€â”€ bin/
â”‚   â”‚   â””â”€â”€ app.ts                      [Entry point de CDK]
â”‚   â”‚
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ ml-retries-stack.ts         [Stack principal - S3, Lambda, Step Functions]
â”‚
â”œâ”€â”€ ğŸ Lambda - Inferencia (Python)
â”‚   â”œâ”€â”€ lambda/
â”‚   â”‚   â”œâ”€â”€ lambda_predict_reintento.py [Handler principal â­]
â”‚   â”‚   â”œâ”€â”€ Dockerfile                  [Imagen Docker para Lambda]
â”‚   â”‚   â””â”€â”€ requirements.txt            [Dependencias Python]
â”‚
â”œâ”€â”€ ğŸ”§ Scripts de Deployment & Testing
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ setup-and-deploy.sh         [Setup automÃ¡tico (â­ ejecutar primero)]
â”‚   â”‚   â”œâ”€â”€ test-lambda.sh              [Testing de Lambda]
â”‚   â”‚   â”œâ”€â”€ test-state-machine.sh       [Testing de State Machine]
â”‚   â”‚   â”œâ”€â”€ upload-model.sh             [Subir modelo a S3 (actualizar sin redeploy)]
â”‚   â”‚   â””â”€â”€ destroy.sh                  [Eliminar recursos AWS (seguro)]
â”‚
â”œâ”€â”€ ğŸ¤– Datos & Modelos
â”‚   â”œâ”€â”€ ejecutar-evaluacion-algoritmos.py  [Script original de entrenamiento]
â”‚   â”œâ”€â”€ suscripciones.xlsx              [Datos de ejemplo (no versionado)]
â”‚   â””â”€â”€ mejor_modelo.pkl                [Modelo entrenado (generado al ejecutar)]
â”‚
â””â”€â”€ ğŸ“¦ Generados por CDK (despuÃ©s del deploy)
    â”œâ”€â”€ node_modules/                   [Dependencias Node.js]
    â”œâ”€â”€ dist/                           [TypeScript compilado]
    â””â”€â”€ cdk.out/                        [CloudFormation templates]


FLOW DE EJECUCIÃ“N
==================

1ï¸âƒ£  PREPARACIÃ“N
   npm install                     â†’ Instala dependencias
   python3 ejecutar-evaluacion... â†’ Entrena modelo

2ï¸âƒ£  DEPLOYMENT (AutomÃ¡tico con script)
   ./scripts/setup-and-deploy.sh
   â”‚
   â”œâ”€â†’ npm run build              â†’ Compila TypeScript
   â”œâ”€â†’ npx cdk synth              â†’ Valida infraestructura
   â”œâ”€â†’ npx cdk deploy             â†’ Crea recursos en AWS
   â””â”€â†’ aws s3 cp ...              â†’ Sube modelo a S3

3ï¸âƒ£  TESTING
   ./scripts/test-lambda.sh        â†’ Prueba Lambda directamente
   ./scripts/test-state-machine.sh â†’ Prueba State Machine end-to-end

4ï¸âƒ£  MONITOREO
   aws logs tail ...               â†’ Ver logs en tiempo real


ESTRUCTURA DE ENTRADA/SALIDA
=============================

INPUT a Lambda:
{
  "monto": 150.0,                    â† NÃºmero
  "delta_horas": 5.0,                â† NÃºmero
  "retry_hour": 10,                  â† NÃºmero (0-23)
  "retry_dayofweek": 2,              â† NÃºmero (0-6)
  "retry_is_weekend": 0,             â† NÃºmero (0/1)
  "error_categoria": "cliente_4xx",  â† String
  "detalle_fail": "Saldo...",        â† String
  "retry_hora_bucket": "manana"      â† String
}

OUTPUT de Lambda:
{
  "statusCode": 200,
  "body": {
    "probabilidad_exito": 0.78,    â† 0-1
    "reintentar": true,             â† Boolean
    "threshold_usado": 0.3          â† 0-1
  }
}


RECURSOS EN AWS
================

S3 Bucket
â”œâ”€ Nombre: ml-retries-model-{ACCOUNT}-{REGION}
â”œâ”€ Versionado: SÃ­
â”œâ”€ EncriptaciÃ³n: SSE-S3
â””â”€ Contiene: models/mejor_modelo.pkl

Lambda Function
â”œâ”€ Nombre: MlRetriesStack-InferenceLambda...
â”œâ”€ Runtime: Python 3.11 (Docker)
â”œâ”€ Timeout: 60 segundos
â”œâ”€ Memoria: 512 MB
â”œâ”€ Logs: /aws/lambda/ml-retries-inference (30 dÃ­as)
â””â”€ Env vars: MODEL_BUCKET, MODEL_KEY, THRESHOLD, LOG_LEVEL

Step Functions State Machine
â”œâ”€ Nombre: RetriesStateMachine
â”œâ”€ Tipo: Standard
â”œâ”€ Pasos: Map â†’ Lambda â†’ Choice â†’ Result
â””â”€ Capacidad: 5 reintentos paralelos


ARCHIVOS CLAVE (En orden de importancia)
==========================================

1. QUICKSTART.md
   â†’ CÃ³mo empezar en 5 minutos

2. scripts/setup-and-deploy.sh
   â†’ Deployment automÃ¡tico (ejecutar primero)

3. lambda/lambda_predict_reintento.py
   â†’ CÃ³digo del handler (bien comentado)

4. lib/ml-retries-stack.ts
   â†’ DefiniciÃ³n de infraestructura

5. README.md
   â†’ DocumentaciÃ³n completa con troubleshooting


PRÃ“XIMOS PASOS
==============

1. Leer: QUICKSTART.md
2. Ejecutar: ./scripts/setup-and-deploy.sh
3. Testear: ./scripts/test-lambda.sh
4. Ver logs: aws logs tail /aws/lambda/ml-retries-inference --follow
5. Leer: README.md para mÃ¡s detalles


VARIABLES DE ENTORNO (Lambda)
==============================

MODEL_BUCKET  = Nombre del bucket S3 con el modelo
MODEL_KEY     = Ruta del modelo (default: models/mejor_modelo.pkl)
THRESHOLD     = Umbral de decisiÃ³n (default: 0.3, rango: 0-1)
LOG_LEVEL     = Nivel de logging (default: INFO)


COSTOS ESTIMADOS (AWS)
======================

S3         â†’ $0.02/mes
Lambda     â†’ $0.20/mes (10k invocaciones)
Step Func  â†’ $0.25/mes (10k ejecuciones)
CloudWatch â†’ $0.50/mes (logs)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL      â†’ ~$1/mes (muy bajo para testing)


LIMPIEZA
========

Destruir infraestructura (automÃ¡tico + seguro):
  ./scripts/destroy.sh

Nota: El script elimina TODO automÃ¡ticamente (S3, Lambda, Step Functions, IAM, logs)
      Requiere confirmaciÃ³n manual (escribir 'eliminar-todo')


ATAJOS ÃšTILES
=============

Ver logs:
  aws logs tail /aws/lambda/ml-retries-inference --follow

Invocar Lambda manualmente:
  aws lambda invoke --function-name {NAME} --payload file://payload.json response.json

Listar recursos:
  aws cloudformation describe-stacks --stack-name ml-retries-stack

Ver Ã¡rbol del proyecto:
  tree -I 'node_modules|dist|cdk.out'


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Documento actualizado: Noviembre 2025
Para dudas, ver README.md o QUICKSTART.md
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
